# OOPSLA Artifact Evaluation

Our tool `FlashProfile` has been released as a C# module, called [`Matching.Text`][MText], within the publicly-available [PROSE] library from Microsoft. Note that, the source code for `FlashProfile` is _not_ publicly-available (also see the [PROSE License] for terms of use). However, our artifiact is a C# executable tool to examine the various claims made in our paper, which uses `Matching.Text` as a [NuGet] library dependency.

**NOTE**: The `Matching.Text` implementation (and more generally `PROSE` framework) has been updated and improved since its release. However, the results claimed in our paper can be reproduced with `PROSE` version `2.2.0` from NuGet. Upgrading the `PROSE` dependency to a newer version may not compile, and may produce different results.

### Claims supported by the artifact
- Working code for various examples of syntactic similarity over strings, and profiling examples, as demonstrated in our paper
- Full datasets used for all profiling tasks, performance analysis and accuracy analysis of `FlashProfile`
- A thorough evaluation of the impact of various parameters (especially &mu; and &theta;)


### Claims NOT supported by the artifact
- Quality of profiles generated by [Microsoft SSDT] and [Ataccama ONE] (related to _Fig.19(a)_ and _Fig.19(b)_)  
  _Reason_: (1) SSDT is only avaialable for Microsoft Windows, whereas our artifact
  is intended to run on Linux. (2) Ataccama ONE does not expose API endpoints but only provides a web applications where users have to upload datasets for profiling. Our current approach has been to manually generate profiles from SSDT on Windows, and Ataccama on their website, and then compare the quality of the generated profiles on Linux.
- Improvements to `Flash Fill`, possible due to integration with `FlashProfile` (related to _&sect;6_)  
  _Reason_: The benchmarks used for this experiments are confidential and proprietary to Microsoft. They are a much larger superset of the original set of `Flash Fill` benchmarks from POPL 2011, with many more real-life scenarios collected via telemetry from products powered by the [PROSE] technology.
- Performance claims as demonstrated in our paper  
  _Reason_: Our artifact submission for OOPSLA is packaged in a virtual machine. Running within a VM might result in significant performance degradation. We recommend using our [`docker`][Docker] image which are [reported](http://domino.research.ibm.com/library/cyberdig.nsf/papers/0929052195DD819C85257D2300681E7B/$File/rc25482.pdf) to have a much smaller overhead than VMs.


## _tl;dr_: Quick verification of claims:  

**Please note:**
1. All commands mentioned in this file must be run at the root of the repository (`~/FlashProfileDemo/` in the VM).
2. Make sure you run `make clean ; make init` once within the repo.

Each of the following `make` commands generates several logs in the `logs/` subdirectory, and one or more plots in the `plots/` subdirectory.

- `dotnet run profile motivating_example.json`: Run profiling tasks for our motivating example (_&sect;1: Fig.1(d), Fig.2(a), Fig.2(b)_)
  - _Est. Time:_ 1 min, prints the profiles
- `make similarity`: [Compute our dissimilarity measure &eta;](#dissimilarity-measure) and compare to baseline similarity measures generated by `FlashProfile` (_&sect;5.1_)
  - _Est. Time:_ 30 mins, generates a plot similar to _Fig.16(a)_
- `make clustering`: Observe the impact of sampling parameters [on clustering accuracy (NMI) and performance](#on-clustering-accuracy-and-performance) (_&sect;5.2: Partitioning_ and _&sect;5.3_)
  - _Est. Time:_ >24 hours, generates plots similar to _Fig.17, Fig.20(a), Fig.20(b)_
    - This is because, we run a grid search over all <&mu;,&theta;> configurations in &mu; &straightepsilon; { 1.0, 1.5, ... , 4.5, 5.0 } x &theta; &straightepsilon; { 1.00, 1.25, ... , 2.75, 3.00 }.
  - We provide a _quick_ version which only explores &mu; &straightepsilon; { 1.0, ... , 5.0 } x &theta; &straightepsilon; { 1.00, 1.25, 1.50, 1.75, 2.00 }:  
    `make quick-clustering`
    - _Est. Time:_ 3 hours, generates plots similar to _Fig.17, Fig.20(a), Fig.20(b)_
- `make quality`: Analyze the [quality of descriptions](#on-quality-of-descriptions) generated by `FlashProfile` (_&sect;5.2: Descriptions_)
  - _Est. Time:_ 15 mins, generates plots similar to _Fig.18_
- `make perf-tests`: Test all 153 [profiling tasks](#profiling-tasks) over 75 publicly available datasets (see [test/](test/)), and measure profiling times (_&sect;5.3_)
  - _Est. Time:_ 30 mins, generates plots similar to _Fig.21_
- Use the following commands to try the two examples from _&sect;5.4_:
  - `dotnet run profile tests/hetero/us_canada_zip_codes.json`: (_Fig.22_)
  - `dotnet run profile tests/hetero/primary_routes.json`: (_Fig.23_)
  - _Est. Time:_ 2 mins, prints profiles shown in _Fig.22, Fig. 23_



## Profiling Tasks

**Example Command:**
```
$ dotnet run profile motivating_example.json
```

<details>

<summary> <kbd>CLICK</kbd> to see the expected output. </summary>

```
# motivating_example.json (1451 strings)
=======================================

> Number of patterns allowed = <auto>
---------------------------------------
    [    5 |   0.34 %] ==> 'not_available'
                        @ not_available
    [  121 |   8.34 %] ==> 'doi:' · [Space]+ · <DOI>
                        @ doi:    10.13039/100001409
    [  301 |  20.74 %] ==> 'ISBN:' · [Space]{1} · <ISBN10>
                        @ ISBN: 3-540-33663-X
    [ 1024 |  70.57 %] ==> 'PMC' · [Digit]{7}
                        @ PMC1355782
.......................................

> Number of patterns allowed = 5
---------------------------------------
    [  110 |   7.58 %] ==> 'doi:' · [Space]+ · '10.13039/' · [Digit]+
                        @ doi:    10.13039/100001409
    [   11 |   0.76 %] ==> 'doi:' · [Space]+ · '10.1016/' · [Upper]{1} · [Digit]{4} · '-' · [Digit]{4} · '(' · [Digit]{2} · ')' · [Digit]{5} · '-' · [Digit]{1}
                        @ doi: 10.1016/S1387-7003(03)00113-8
    [    5 |   0.34 %] ==> 'not_available'
                        @ not_available
    [  301 |  20.74 %] ==> 'ISBN:' · [Space]{1} · <ISBN10>
                        @ ISBN: 3-540-33663-X
    [ 1024 |  70.57 %] ==> 'PMC' · [Digit]{7}
                        @ PMC1355782
.......................................

> Number of patterns allowed = <auto>
---------------------------------------
    [    5 |   0.34 %] ==> 'not_available'
                        @ not_available
    [   11 |   0.76 %] ==> 'doi:' · [Space]+ · '10.1016/' · [Upper]{1} · [Digit]{4} · '-' · [Digit]{4} · '(' · [Digit]{2} · ')' · [Digit]{5} · '-' · [Digit]{1}
                        @ doi: 10.1016/S1387-7003(03)00113-8
    [  267 |  18.40 %] ==> 'ISBN:' · [Space]{1} · [Digit]{1} · '-' · [Digit]{3} · '-' · [Digit]{5} · '-' · [Digit]{1}
                        @ ISBN: 0-037-32102-8
    [   34 |   2.34 %] ==> 'ISBN:' · [Space]{1} · [Digit]{1} · '-' · [Digit]{3} · '-' · [Digit]{5} · '-X'
                        @ ISBN: 3-540-33663-X
    [  110 |   7.58 %] ==> 'doi:' · [Space]+ · '10.13039/' · [Digit]+
                        @ doi:    10.13039/100001409
    [ 1024 |  70.57 %] ==> 'PMC' · [Digit]{7}
                        @ PMC1355782
.......................................

```
</details>

This command generates profiles for [`motivating_example.json`](motivating_example.json) file which contains
the dataset from _Fig. 1(a)_ of our paper, with 3 profiling tasks:

1. _Fig. 2(a)_: automatic profiling task with `<DOI>` and `<ISBN>` atoms,
2. _Fig. 2(b)_: refinement task requesting for one more (5) patterns, and
3. _Fig. 1(d)_: automatic profiling task with only default atoms.

The two examples detailed in _&sect;5.4_ may be similarly executed, as described above. They are located in files: [test/us_canada_zip_codes.json](test/us_canada_zip_codes.json) (for _Fig.22_) and [test/primary_routes.json](test/primary_routes.json) (for _Fig.23_) respectively.

<details>

<summary> <kbd>CLICK</kbd> to see instructions on defining new profiling tasks. </summary>

The format for the JSON file specifying the dataset and the tasks is as shown below:

```json
{
    "Results": [
        {
            // Automatic profiling task,
            // requires no special options.
        },
        {
            // Refinement task.
            "Disjuncts": n,
        },
        {
            // Refinement task with custom atoms.
            "Disjuncts": num_disjuncts__int,
            "CustomRegexTokens": [
                {
                "Name": "atom_name",
                "Regex": "atom_regex",
                "Score": atom_score__float
                },
                ...
            ]
        },
        ...
    ],
    "Data": [
        "string_1",
        "string_2",
        ...
    ]
}
```
Please see [motivating_example.json](motivating_example.json) file, and the files within [test/](test/) directory for concrete examples. All datasets in [test/](test/) additionally have a `"Source"` key in the JSON file which indicates the original source (a publicly-available internet link) for the dataset.

</details>

The following command runs `FlashProfile` on all profiling tasks described within [test/](test/) and reports if the profiles match the expected profiles:
```
$ dotnet run tests
```



## Dissimilarity Measure

**Example Command:**
```
$ dotnet run eta "1990-11-23" "2001-02-10"
```

<details>

<summary> <kbd>CLICK</kbd> to see the expected output. </summary>

```
> { '1990-11-23' , '2001-02-10' } => [Digit]{4} & Const[-] & [Digit]{2} & Const[-] & [Digit]{2}
> Pairwise Dissimilarity = 4.955752

> Total Number of Consistent Patterns = 99292.

> 5 Randomly Selected Patterns:
  *  18928.37406 : [Alpha|Digit]+ · [Dot|Dash]{1} · [Digit]+ · [Alpha|Dash]{1} · [Any]+
  *    268.14257 : [Alpha|Digit]+ · [Dot|Dash]{1} · [HexDigit]+ · '-' · [HexDigit]+
  *    986.08443 : [Alpha|Digit|Space]{4} · [Alpha|Dash]{1} · [Alpha|Digit]{2} · [Symbol]{1} · [Alpha|Digit|Space]{2}
  *  22116.55657 : [Base64]+ · [Dot|Dash]+ · [Alpha|Digit|Space]+ · [Symbol]+ · [Any]+
  *   3331.24139 : [Base64]+ · [Punct]{1} · [Alpha|Digit|Space]{2} · [Dot|Dash]+ · [Digit]+
```
</details>

This command generates the pairwise dissimilarity (the measure &eta; from _Definition 3.1_) between the given strings. The example command computes the &eta; for the first pair from _Example 3.2_. Other examples (from _Example 2.3_, _Example 3.4_, and _Example 4.5_ as well) may be similarly executed.

Given _n_ strings, it outputs:

1. For all pairs of strings _a_ and _b_: &eta;(_a_, _b_), and the best pattern describing _a_ and _b_,
2. The overall dissimilarity and overall best pattern, if _n_ > 2,
3. The total number of pattens consistent with all given strings, and
4. A randomly selected sample of patterns (besides the overall best pattern)



## Impact of Sampling Parameters

### On Clustering Accuracy and Performance

**Example Command:**
```
$ dotnet run clustering [--mu=4.0] [--theta=1.25]
```

<details>

<summary><kbd>CLICK</kbd> to show all commandline options </summary>

```
 -t, --trials-per-clustering      (Default: 10) Number of trials per a particular number of clusters.

  -s, --num-strings-per-cluster    (Default: 256) The theta parameter for FlashProfile.

  -m, --min-clusters               (Default: 2) The minimum number of clusters to test.

  -M, --max-clusters               (Default: 8) The maximum number of clusters to test.

  -e, --theta                      (Default: 1.25) The theta parameter for FlashProfile.

  -u, --mu                         (Default: 4) The mu parameter for FlashProfile.
```
</details>

This command computes the average accuracy of recovering _N_ clusters, for each _N_ &straightepsilon; [_m_, _M_] each containing at most _S_ strings (drawn from _N_ datasets belonging to the Cʟᴇᴀɴ group), with the given sampling parameters: &mu; and &theta; over _T_ trials. (More details in _&sect;5.2: Partitions_)

The command shown above also records profiling times for each <&mu;,&theta;> configuration. They may be plotted by running `./python/plotting/clustering.py`.

### On Quality of Descriptions

**Example Command:**
```
$ dotnet run quality 0.2 [--mu=4.0] [--theta=1.25]
```

This command computes our quality measure for profiles generated for datasets within the Dᴏᴍᴀɪɴꜱ group. We profile a fraction _f_ (= 20% in the command above) of strings from each dataset and compute the _precision_: fraction of the remaining dataset that is matched by the profile, and _recall_: fraction of strings randomly sampled from other datasets that is matched by the profile. The overall quality is the average F1 score over all tested datasets. (More details in _&sect;5.2: Descriptions_)



[Ataccama ONE]: https://one.ataccama.com/
[Docker]: https://www.docker.com/
[Microsoft SSDT]: https://docs.microsoft.com/en-gb/sql/ssdt
[MText]: https://microsoft.github.io/prose/documentation/matching-text/intro/
[NuGet]: https://www.nuget.org
[PROSE]: https://microsoft.github.io/prose/
[PROSE License]: https://microsoft.github.io/prose/SDKLicense.pdf